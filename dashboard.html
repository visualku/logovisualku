<!DOCTYPE html>
<html lang="id">
<head>
    <title>Dashboard - LogoVisualku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #ffffff; color: #1a1a1a; }
        .navbar { background: white; box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1); padding: 1rem 0; }
        .navbar-brand { font-weight: 700; color: #001f4d !important; font-size: 1.5rem; }
        .sidebar { min-height: 100vh; background: #001f4d; color: white; padding: 20px 0; }
        .sidebar a { color: #a0d8ff; text-decoration: none; padding: 12px 20px; display: block; }
        .sidebar a:hover, .sidebar a.active { background: #001533; color: white; }
        .card { border-radius: 16px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .btn-primary { background-color: #001f4d; border: none; padding: 10px 25px; border-radius: 50px; font-weight: 600; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-trophy me-2"></i>LogoVisualku
            </a>
            <div class="ms-auto">
                <button id="logoutBtn" class="btn btn-outline-primary btn-sm">Keluar</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-5">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <h5 class="px-4 pb-3 border-bottom">Dashboard</h5>
                    <a href="#kontes-saya" class="active" onclick="showTab('kontes-saya')">Kontes Saya</a>
                    <a href="#verifikasi" onclick="showTab('verifikasi')">Verifikasi Pembayaran</a>
                    <a href="#semua-kontes" onclick="showTab('semua-kontes')">Semua Kontes</a>
                    <a href="#chat" onclick="showTab('chat')">Chat dengan Desainer</a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Tab: Kontes Saya -->
                <div id="kontes-saya" class="tab-content">
                    <h4>Kontes Saya</h4>
                    <p>Anda belum membuat kontes.</p>
                </div>

                <!-- Tab: Verifikasi Pembayaran -->
                <div id="verifikasi" class="tab-content" style="display: none;">
                    <h4>Verifikasi Pembayaran</h4>
                    <div class="card">
                        <div class="card-body">
                            <p><strong>Masukkan Kode Kontes (10 digit):</strong></p>
                            <input type="text" id="codeInput" placeholder="1008257382" class="form-control mb-3" style="max-width: 300px;">
                            <button class="btn btn-primary" onclick="verify()">Cek Kode</button>
                        </div>
                    </div>
                    <div id="verificationResult"></div>
                </div>

                <!-- Tab: Semua Kontes -->
                <div id="semua-kontes" class="tab-content" style="display: none;">
                    <h4>Semua Kontes</h4>
                    <div id="allContestsList">
                        <p>Memuat daftar kontes...</p>
                    </div>
                </div>

                <!-- Tab: Chat -->
                <div id="chat" class="tab-content" style="display: none;">
                    <h4>Chat dengan Desainer</h4>
                    <p>Saat ini tidak ada percakapan aktif.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Global Version - Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBmoIXKp8BABwBMqKKXhSUBLGnYSnKNAYg",
            authDomain: "logovisualku.firebaseapp.com",
            projectId: "logovisualku",
            storageBucket: "logovisualku.firebasestorage.app",
            messagingSenderId: "64489762880",
            appId: "1:64489762880:web:f55f26b068044f1320afa5"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Cek login
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                // Tampilkan tab sesuai role
                if (user.email === "admin@visualku.com") {
                    document.getElementById('verifikasi').style.display = 'block';
                    document.getElementById('semua-kontes').style.display = 'block';
                } else {
                    // Cek role dari Firestore
                    const snapshot = await db.collection('users').where('uid', '==', user.uid).get();
                    if (!snapshot.empty) {
                        const role = snapshot.docs[0].data().role;
                        if (role === 'ch') {
                            document.getElementById('kontes-saya').style.display = 'block';
                        } else if (role === 'designer') {
                            document.getElementById('kontes-saya').style.display = 'block';
                        }
                    }
                }
            }
        });

        // Tab Navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';
        }

        // Verifikasi Pembayaran
        window.verify = async () => {
            const code = document.getElementById('codeInput').value;
            if (!code) return;

            const q = db.collection('contests').where('contestCode', '==', code);
            const snapshot = await q.get();
            const resultDiv = document.getElementById('verificationResult');

            if (!snapshot.empty) {
                const doc = snapshot.docs[0];
                const data = doc.data();
                resultDiv.innerHTML = `
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5>Detail Kontes</h5>
                            <p><strong>Nama Bisnis:</strong> ${data.businessName}</p>
                            <p><strong>Deskripsi:</strong> ${data.description}</p>
                            <p><strong>Paket:</strong> ${data.package}</p>
                            <p><strong>Hadiah:</strong> Rp ${data.prize.toLocaleString()}</p>
                            <p><strong>Status:</strong> <span style="color: ${data.status === 'active' ? 'green' : 'orange'};">${data.status}</span></p>
                            <button class="btn btn-primary" onclick="start('${doc.id}')">Mulai Kontes</button>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger mt-3">Kode kontes tidak ditemukan</div>';
            }
        };

        // Mulai Kontes
        window.start = async (id) => {
            const docRef = db.collection('contests').doc(id);
            await docRef.update({ status: 'active' });
            alert('Kontes berhasil dimulai!');
            document.getElementById('verificationResult').innerHTML = '';
            document.getElementById('codeInput').value = '';
        };

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                alert("Gagal keluar: " + error.message);
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
