<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LogoVisualku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
        body { background:#f8f9fa; color:#1a1a1a; }
        .navbar { background:white; box-shadow:0 2px 20px rgba(0,0,0,0.1); padding:1rem 0; }
        .navbar-brand { font-weight:700; color:#001f4d !important; }
        .sidebar { min-height:100vh; background:#001f4d; color:white; padding:20px 0; }
        .sidebar a { color:#a0d8ff; text-decoration:none; padding:12px 20px; display:block; }
        .sidebar a:hover, .sidebar a.active { background:#001533; color:white; }
        .card { border-radius:16px; box-shadow:0 5px 15px rgba(0,0,0,0.05); margin-bottom:20px; }
        .btn-primary { background:#001f4d; border:none; padding:10px 25px; border-radius:50px; font-weight:600; }
        .tab-content { padding:20px; background:white; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">LogoVisualku</a>
            <button id="logoutBtn" class="btn btn-outline-primary btn-sm">Keluar</button>
        </div>
    </nav>

    <div class="container-fluid py-5">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <h5 class="px-4 pb-3 border-bottom">Dashboard</h5>
                    <a href="#kontes-saya" class="active" onclick="showTab('kontes-saya')">Kontes Saya</a>
                    <a href="#verifikasi" onclick="showTab('verifikasi')">Verifikasi Pembayaran</a>
                    <a href="#semua-kontes" onclick="showTab('semua-kontes')">Semua Kontes</a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Admin Panel -->
                <div id="verifikasi" class="tab-content" style="display:none;">
                    <h4>Verifikasi Pembayaran</h4>
                    <div class="card">
                        <div class="card-body">
                            <p><strong>Masukkan Kode Kontes (10 digit):</strong></p>
                            <input type="text" id="codeInput" class="form-control mb-3" style="max-width:300px;">
                            <button class="btn btn-primary" onclick="verify()">Cek Kode</button>
                        </div>
                    </div>
                    <div id="verificationResult"></div>
                </div>

                <!-- CH Panel -->
                <div id="kontes-saya" class="tab-content">
                    <h4>Kontes Saya</h4>
                    <div id="chContestDetails"></div>
                    <div id="designGallery"></div>
                </div>

                <!-- All Contests -->
                <div id="semua-kontes" class="tab-content" style="display:none;">
                    <h4>Semua Kontes</h4>
                    <div id="allContestsList">
                        <p>Memuat kontes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBmoIXKp8BABwBMqKKXhSUBLGnYSnKNAYg",
            authDomain: "logovisualku.firebaseapp.com",
            projectId: "logovisualku",
            storageBucket: "logovisualku.firebasestorage.app",
            messagingSenderId: "64489762880",
            appId: "1:64489762880:web:f55f26b068044f1320afa5"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Cek Login
        window.onload = async () => {
            const chLoggedIn = sessionStorage.getItem('chLoggedIn');
            const chContestCode = sessionStorage.getItem('chContestCode');

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    if (user.email === "admin@visualku.com") {
                        showTab('verifikasi');
                        loadAllContests();
                    } else {
                        const q = db.collection('users').where('uid', '==', user.uid);
                        const snap = await q.get();
                        if (!snap.empty) {
                            showTab('kontes-saya');
                            document.getElementById('kontes-saya').innerHTML = '<p>Hanya untuk desainer.</p>';
                        }
                    }
                } else if (chLoggedIn && chContestCode) {
                    showTab('kontes-saya');
                    loadCHContest(chContestCode);
                } else {
                    window.location.href = 'index.html';
                }
            });
        };

        // Tab Navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
        }

        // Load CH Contest
        async function loadCHContest(code) {
            const q = db.collection('contests').where('contestCode', '==', code);
            const snap = await q.get();
            const details = document.getElementById('chContestDetails');
            const gallery = document.getElementById('designGallery');

            if (!snap.empty) {
                const data = snap.docs[0].data();
                details.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5>${data.businessName}</h5>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Hadiah:</strong> Rp ${data.prize.toLocaleString()}</p>
                        </div>
                    </div>
                `;
                // Tampilkan desain
                const subs = await db.collection('submissions').where('contestCode', '==', code).get();
                gallery.innerHTML = '<h5>Desain dari Desainer</h5>';
                subs.forEach(sub => {
                    const img = document.createElement('img');
                    img.src = 'https://placehold.co/150x150/001f4d/ffffff?text=LOGO';
                    img.style.margin = '5px';
                    gallery.appendChild(img);
                });
            }
        }

        // Verifikasi Pembayaran
        window.verify = async () => {
            const code = document.getElementById('codeInput').value;
            const q = db.collection('contests').where('contestCode', '==', code);
            const snap = await q.get();
            const result = document.getElementById('verificationResult');

            if (!snap.empty) {
                const doc = snap.docs[0];
                const data = doc.data();
                result.innerHTML = `
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5>Detail Kontes</h5>
                            <p><strong>Nama:</strong> ${data.businessName}</p>
                            <p><strong>Paket:</strong> ${data.package}</p>
                            <p><strong>Hadiah:</strong> Rp ${data.prize.toLocaleString()}</p>
                            <p><strong>Status:</strong> <span style="color:${data.status==='active'?'green':'orange'};">${data.status}</span></p>
                            <button class="btn btn-primary" onclick="start('${doc.id}')">Mulai Kontes</button>
                        </div>
                    </div>
                `;
            } else {
                result.innerHTML = '<div class="alert alert-danger mt-3">Kode tidak ditemukan</div>';
            }
        };

        // Mulai Kontes + Kirim ke WhatsApp Saluran
        window.start = async (id) => {
            const docRef = db.collection('contests').doc(id);
            const doc = await docRef.get();
            const data = doc.data();

            await docRef.update({ status: 'active' });

            // Kirim ke saluran WhatsApp
            const message = `*ðŸŽ‰ KONTES DIMULAI!*%0A%0A*Nama:* ${encodeURIComponent(data.businessName)}%0A*Deskripsi:* ${encodeURIComponent(data.description)}%0A*Paket:* ${data.package}%0A*Hadiah:* Rp ${data.prize.toLocaleString()}%0A*Kode:* ${data.contestCode}%0A%0ALihat: https://logovisualku.web.app/detail-kontes.html?code=${data.contestCode}`;
            const channelLink = `https://wa.me/6285183089108?text=${message}`;
            window.open(channelLink, '_blank');

            alert('Kontes dimulai! Notifikasi dikirim ke saluran WhatsApp.');
            document.getElementById('verificationResult').innerHTML = '';
            document.getElementById('codeInput').value = '';
        };

        // Load All Contests
        window.loadAllContests = async () => {
            const list = document.getElementById('allContestsList');
            list.innerHTML = '';
            const q = db.collection('contests');
            const snap = await q.get();
            snap.forEach(doc => {
                const data = doc.data();
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-body">
                        <h6>${data.businessName}</h6>
                        <p>${data.description.substring(0,80)}...</p>
                        <div class="d-flex justify-content-between">
                            <span>Rp ${data.prize.toLocaleString()}</span>
                            <span class="badge bg-${data.status==='active'?'success':'warning'}">${data.status}</span>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        };

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.clear();
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>
