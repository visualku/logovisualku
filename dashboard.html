<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - LogoVisualku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tab { display: none; }
        .active { display: block; }
        .sidebar a { display: block; padding: 10px; text-decoration: none; color: #001f4d; }
        .sidebar a:hover { background: #f0f5ff; }
    </style>
</head>
<body>
    <!-- HEADER -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">LogoVisualku</a>
            <button id="logoutBtn" class="btn btn-outline-primary btn-sm">Keluar</button>
        </div>
    </nav>

    <div class="container-fluid py-5">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <h5>Dashboard</h5>
                    <a href="#" onclick="showTab('admin')">Admin Panel</a>
                    <a href="#" onclick="showTab('ch')">Kontes Saya</a>
                    <a href="#" onclick="showTab('designer')">Desainer</a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Admin Panel -->
                <div id="admin" class="tab">
                    <h4>Admin Panel</h4>
                    <p>Anda adalah admin. Anda bisa verifikasi pembayaran dan lihat semua kontes.</p>
                    <input type="text" id="codeInput" placeholder="Kode Kontes">
                    <button onclick="verify()">Verifikasi</button>
                    <div id="result"></div>
                </div>

                <!-- CH Panel -->
                <div id="ch" class="tab">
                    <h4>Kontes Anda</h4>
                    <p>Anda bisa melihat detail kontes Anda di sini.</p>
                    <div id="chContestDetails"></div>
                    <div id="designGallery"></div>
                </div>

                <!-- Designer Panel -->
                <div id="designer" class="tab">
                    <h4>Kontes yang Diikuti</h4>
                    <p>Anda bisa lihat kontes aktif di <a href="kontes.html">Kontes Aktif</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBmoIXKp8BABwBMqKKXhSUBLGnYSnKNAYg",
        authDomain: "logovisualku.firebaseapp.com",
        projectId: "logovisualku",
        storageBucket: "logovisualku.firebasestorage.app",
        messagingSenderId: "64489762880",
        appId: "1:64489762880:web:f55f26b068044f1320afa5"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Tab Navigation
      function showTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
      }

      // Cek Login
      onAuthStateChanged(auth, async (user) => {
        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn.onclick = () => auth.signOut().then(() => window.location.href = 'index.html');

        if (user) {
          if (user.email === "admin@visualku.com") {
            showTab('admin');
          } else {
            const q = query(collection(db, 'users'), where('uid', '==', user.uid));
            const snap = await getDocs(q);
            if (!snap.empty) {
              const data = snap.docs[0].data();
              if (data.role === 'designer') {
                showTab('designer');
              }
            }
          }
        } else {
          // Cek apakah CH login
          const chLoggedIn = sessionStorage.getItem('chLoggedIn');
          const chContestCode = sessionStorage.getItem('chContestCode');
          if (chLoggedIn && chContestCode) {
            showTab('ch');
            loadCHContest(chContestCode);
          } else {
            window.location.href = 'index.html';
          }
        }
      });

      // Load CH Contest
      async function loadCHContest(code) {
        const q = query(collection(db, 'contests'), where('contestCode', '==', code));
        const snap = await getDocs(q);
        const details = document.getElementById('chContestDetails');
        if (!snap.empty) {
          const data = snap.docs[0].data();
          details.innerHTML = `<p><strong>Bisnis:</strong> ${data.businessName}</p>`;
        }
      }

      // Verifikasi Pembayaran
      window.verify = async () => {
        const code = document.getElementById('codeInput').value;
        const q = query(collection(db, 'contests'), where('contestCode', '==', code));
        const snap = await getDocs(q);
        const result = document.getElementById('result');
        if (!snap.empty) {
          const doc = snap.docs[0];
          result.innerHTML = `<p>Kontes ditemukan: ${doc.data().businessName}. <button onclick="start('${doc.id}')">Mulai Kontes</button></p>`;
        } else {
          result.innerHTML = '<p>Kode tidak ditemukan</p>';
        }
      };

      // Mulai Kontes
      window.start = async (id) => {
        const docRef = doc(db, 'contests', id);
        const doc = await docRef.get();
        if (doc.exists()) {
          await docRef.update({ status: 'active' });
          alert('Kontes dimulai!');
        }
      };
    </script>
</body>
</html>
