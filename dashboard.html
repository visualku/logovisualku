<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LogoVisualku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f8f9fa; color: #1a1a1a; }
        .navbar { background: white; box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1); padding: 1rem 0; }
        .navbar-brand { font-weight: 700; color: #001f4d !important; font-size: 1.5rem; }
        .nav-link { color: #333 !important; margin: 0 10px; }
        .sidebar { min-height: 100vh; background: #001f4d; color: white; padding: 20px 0; }
        .sidebar a { color: #a0d8ff; text-decoration: none; padding: 12px 20px; display: block; }
        .sidebar a:hover, .sidebar a.active { background: #001533; color: white; }
        .card { border-radius: 16px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .btn-primary { background: #001f4d; border: none; padding: 10px 25px; border-radius: 50px; font-weight: 600; }
        footer { background: #001f4d; color: #ddd; padding: 60px 0 30px; }
        footer a { color: #a0d8ff; text-decoration: none; }
    </style>
</head>
<body>
    <!-- HEADER -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-trophy me-2"></i>LogoVisualku
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Beranda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="kontes.html">Kontes Aktif</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-primary btn-sm ms-2" onclick="toggleLogin()">Masuk</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-5">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <h5 class="px-4 pb-3 border-bottom">Dashboard</h5>
                    <a href="#admin" id="adminTab" style="display:none;" class="active" onclick="showTab('admin')">Admin Panel</a>
                    <a href="#ch" id="chTab" style="display:none;" onclick="showTab('ch')">Kontes Saya</a>
                    <a href="#designer" id="designerTab" style="display:none;" onclick="showTab('designer')">Desainer</a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Admin Panel -->
                <div id="admin" class="tab-content">
                    <h4>Verifikasi Pembayaran</h4>
                    <div class="card">
                        <div class="card-body">
                            <p><strong>Masukkan Kode Kontes (10 digit):</strong></p>
                            <input type="text" id="codeInput" class="form-control mb-3" style="max-width:300px;">
                            <button class="btn btn-primary" onclick="verify()">Cek Kode</button>
                        </div>
                    </div>
                    <div id="verificationResult"></div>
                </div>

                <!-- CH Panel -->
                <div id="ch" class="tab-content" style="display:none;">
                    <h4>Kontes Anda</h4>
                    <div id="chContestDetails"></div>
                    <div id="designGallery"></div>
                </div>

                <!-- Designer Panel -->
                <div id="designer" class="tab-content" style="display:none;">
                    <h4>Profil Saya</h4>
                    <p><strong>Email:</strong> <span id="email"></span></p>
                    <p><strong>Bank:</strong> <span id="bank"></span></p>
                    <p><strong>Rekening:</strong> <span id="accountNumber"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <h5>LogoVisualku</h5>
                    <p>Platform kontes logo terbaik di Indonesia. Cepat, mudah, dan hasilnya luar biasa.</p>
                </div>
                <div class="col-lg-2 col-md-4 mb-4">
                    <h6>Link Cepat</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#">Beranda</a></li>
                        <li class="mb-2"><a href="kontes.html">Kontes Aktif</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-4 mb-4">
                    <h6>Kontak</h6>
                    <p><i class="fas fa-whatsapp me-2"></i> 0851-8308-910</p>
                    <p><i class="fas fa-envelope me-2"></i> reneingrid@gmail.com</p>
                </div>
                <div class="col-lg-3 col-md-4">
                    <h6>Untuk Desainer</h6>
                    <p>Hasilkan uang dari kreativitasmu!</p>
                    <a href="daftar.html" class="btn btn-outline-light btn-sm">Daftar Sekarang</a>
                </div>
            </div>
            <hr class="my-4" style="border-color: rgba(255, 255, 255, 0.2);">
            <div class="text-center">
                <p class="mb-0">&copy; 2024 LogoVisualku. Semua hak cipta dilindungi.</p>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
      // Import Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import { getFirestore, collection, getDocs, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBmoIXKp8BABwBMqKKXhSUBLGnYSnKNAYg",
        authDomain: "logovisualku.firebaseapp.com",
        projectId: "logovisualku",
        storageBucket: "logovisualku.firebasestorage.app",
        messagingSenderId: "64489762880",
        appId: "1:64489762880:web:f55f26b068044f1320afa5"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Toggle Login/Logout Button
      window.toggleLogin = () => {
        if (auth.currentUser) {
          auth.signOut().then(() => {
            window.location.href = 'index.html';
          });
        } else {
          window.location.href = 'login.html';
        }
      };

      // Tab Navigation
      window.showTab = (tabId) => {
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.getElementById(tabId).style.display = 'block';
      };

      // Check Login
      onAuthStateChanged(auth, async (user) => {
        const btn = document.querySelector('.btn-outline-primary');
        if (user) {
          btn.textContent = 'Keluar';
          btn.onclick = () => auth.signOut().then(() => window.location.href = 'index.html');

          if (user.email === "admin@visualku.com") {
            document.getElementById('adminTab').style.display = 'block';
            showTab('admin');
          } else {
            const q = query(collection(db, 'users'), where('uid', '==', user.uid));
            const snap = await getDocs(q);
            if (!snap.empty) {
              const data = snap.docs[0].data();
              document.getElementById('email').textContent = data.email;
              document.getElementById('bank').textContent = data.bank;
              document.getElementById('accountNumber').textContent = data.accountNumber;

              if (data.role === 'designer') {
                document.getElementById('designerTab').style.display = 'block';
                showTab('designer');
              }
            }
          }
        } else {
          // Cek apakah CH login via sessionStorage
          const chLoggedIn = sessionStorage.getItem('chLoggedIn');
          const chContestCode = sessionStorage.getItem('chContestCode');
          if (chLoggedIn && chContestCode) {
            btn.textContent = 'Keluar';
            btn.onclick = () => {
              sessionStorage.clear();
              window.location.href = 'index.html';
            };
            document.getElementById('chTab').style.display = 'block';
            loadCHContest(chContestCode);
            showTab('ch');
          } else {
            window.location.href = 'index.html';
          }
        }
      });

      // Load CH Contest
      async function loadCHContest(code) {
        const q = query(collection(db, 'contests'), where('contestCode', '==', code));
        const snap = await getDocs(q);
        const details = document.getElementById('chContestDetails');
        const gallery = document.getElementById('designGallery');

        if (!snap.empty) {
          const data = snap.docs[0].data();
          details.innerHTML = `
            <div class="card">
              <div class="card-body">
                <h5>${data.businessName}</h5>
                <p><strong>Status:</strong> ${data.status}</p>
                <p><strong>Hadiah:</strong> Rp ${data.prize.toLocaleString()}</p>
              </div>
            </div>
          `;
          // Tampilkan desain
          const subs = await getDocs(query(collection(db, 'submissions'), where('contestCode', '==', code)));
          gallery.innerHTML = '<h5>Desain dari Desainer</h5>';
          subs.forEach(sub => {
            const img = document.createElement('img');
            img.src = 'https://placehold.co/150x150/001f4d/ffffff?text=LOGO';
            img.style.margin = '5px';
            gallery.appendChild(img);
          });
        }
      }

      // Verifikasi Pembayaran
      window.verify = async () => {
        const code = document.getElementById('codeInput').value;
        const q = query(collection(db, 'contests'), where('contestCode', '==', code));
        const snap = await getDocs(q);
        const result = document.getElementById('verificationResult');

        if (!snap.empty) {
          const docSnap = snap.docs[0];
          const data = docSnap.data();
          result.innerHTML = `
            <div class="card mt-3">
              <div class="card-body">
                <h5>Detail Kontes</h5>
                <p><strong>Nama:</strong> ${data.businessName}</p>
                <p><strong>Paket:</strong> ${data.package}</p>
                <p><strong>Hadiah:</strong> Rp ${data.prize.toLocaleString()}</p>
                <p><strong>Status:</strong> <span style="color:${data.status==='active'?'green':'orange'};">${data.status}</span></p>
                <button class="btn btn-primary" onclick="start('${docSnap.id}')">Mulai Kontes</button>
              </div>
            </div>
          `;
        } else {
          result.innerHTML = '<div class="alert alert-danger mt-3">Kode tidak ditemukan</div>';
        }
      };

      // Mulai Kontes + Kirim ke WhatsApp Saluran
      window.start = async (id) => {
        const docRef = doc(db, 'contests', id);
        const docSnap = await docRef.get();
        const data = docSnap.data();

        await updateDoc(docRef, { status: 'active' });

        // Kirim ke saluran WhatsApp
        const message = `*🎉 KONTES DIMULAI!*%0A%0A*Nama:* ${encodeURIComponent(data.businessName)}%0A*Deskripsi:* ${encodeURIComponent(data.description)}%0A*Paket:* ${data.package}%0A*Hadiah:* Rp ${data.prize.toLocaleString()}%0A*Kode:* ${data.contestCode}%0A%0ALihat: https://logovisualku.web.app/detail-kontes.html?code=${data.contestCode}`;
        const channelLink = `https://wa.me/6285183089108?text=${message}`;
        window.open(channelLink, '_blank');

        alert('Kontes dimulai! Notifikasi dikirim ke saluran WhatsApp.');
        document.getElementById('verificationResult').innerHTML = '';
        document.getElementById('codeInput').value = '';
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
